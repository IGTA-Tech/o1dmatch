# O1DMatch Content Maker - Website Integration Plan

## Overview

This document outlines options for automatically publishing content generated by the O1DMatch Content Maker v2.0 (Google Apps Script) to the website at www.o1dmatch.com.

**Current State:**
- Content Maker generates articles via Google Apps Script
- Articles are saved to Google Docs + emailed
- Website is Next.js 14 + Supabase + Vercel
- **No blog/articles system exists on website yet**

---

## Architecture Options

### Option A: Webhook to Next.js API Route (Recommended)

**Flow:**
```
Google Apps Script → POST to /api/articles/webhook → Supabase → Website renders
```

**Pros:**
- Real-time publishing
- Full control over article processing
- Can add moderation step if needed
- Serverless (no extra infrastructure)

**Cons:**
- Requires API route development
- Need to secure the webhook endpoint

---

### Option B: Direct Supabase Insert from Apps Script

**Flow:**
```
Google Apps Script → Supabase REST API → Website renders
```

**Pros:**
- Simpler implementation
- No webhook endpoint needed
- Supabase handles authentication

**Cons:**
- Service key exposed in Apps Script (less secure)
- Less flexibility for processing

---

### Option C: Google Drive Polling

**Flow:**
```
Google Apps Script → Google Docs → Vercel Cron polls Drive → Supabase → Website
```

**Pros:**
- Apps Script doesn't need changes
- Human can review in Docs first

**Cons:**
- Not real-time (polling delay)
- More complex setup
- Requires Google API credentials in Vercel

---

## Recommended Implementation: Option A

### Step 1: Supabase Schema Addition

Add this table to Supabase:

```sql
-- Article status enum
CREATE TYPE article_status AS ENUM ('draft', 'published', 'archived');

-- Articles table for content library
CREATE TABLE articles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Content
  title TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  meta_description TEXT,
  content TEXT NOT NULL, -- HTML or Markdown
  excerpt TEXT,

  -- Categorization
  visa_type TEXT NOT NULL, -- O-1A, O-1B, EB-1A, EB-2 NIW
  content_type TEXT NOT NULL, -- Educational, Talent-Focused, Employer-Focused, Competitive, News Commentary
  target_audience TEXT DEFAULT 'Both', -- Talent, Employer, Both
  topic TEXT,
  tags TEXT[] DEFAULT '{}',

  -- Media
  featured_image_url TEXT,

  -- SEO
  reading_time TEXT DEFAULT '5 min read',

  -- Source tracking
  google_doc_url TEXT,
  source_system TEXT DEFAULT 'content-maker-v2',

  -- RAG/News metadata (optional, for analytics)
  news_integration JSONB,
  rag_integration JSONB,
  backlink_report JSONB,

  -- Publishing
  status article_status DEFAULT 'draft',
  published_at TIMESTAMPTZ,

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_articles_slug ON articles(slug);
CREATE INDEX idx_articles_visa_type ON articles(visa_type);
CREATE INDEX idx_articles_content_type ON articles(content_type);
CREATE INDEX idx_articles_status ON articles(status);
CREATE INDEX idx_articles_published_at ON articles(published_at DESC);
CREATE INDEX idx_articles_target_audience ON articles(target_audience);

-- RLS policies
ALTER TABLE articles ENABLE ROW LEVEL SECURITY;

-- Public can read published articles
CREATE POLICY "Public can view published articles"
  ON articles FOR SELECT
  USING (status = 'published');

-- Only service role can insert/update (webhook)
CREATE POLICY "Service role can manage articles"
  ON articles FOR ALL
  USING (auth.role() = 'service_role');
```

---

### Step 2: Next.js API Webhook Endpoint

Create `/src/app/api/articles/webhook/route.ts`:

```typescript
import { createClient } from '@supabase/supabase-js';
import { NextRequest, NextResponse } from 'next/server';

// Use service role for webhook (server-side only)
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

// Webhook secret for authentication
const WEBHOOK_SECRET = process.env.CONTENT_MAKER_WEBHOOK_SECRET;

function generateSlug(title: string): string {
  return title
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '')
    .substring(0, 100);
}

export async function POST(request: NextRequest) {
  try {
    // Verify webhook secret
    const authHeader = request.headers.get('authorization');
    if (authHeader !== `Bearer ${WEBHOOK_SECRET}`) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const body = await request.json();

    // Validate required fields
    const { title, content, visaType, contentType } = body;
    if (!title || !content || !visaType || !contentType) {
      return NextResponse.json(
        { error: 'Missing required fields: title, content, visaType, contentType' },
        { status: 400 }
      );
    }

    // Generate unique slug
    let slug = generateSlug(title);
    const timestamp = Date.now().toString(36);
    slug = `${slug}-${timestamp}`;

    // Prepare article data
    const articleData = {
      title: body.title,
      slug: slug,
      meta_description: body.metaDescription || null,
      content: body.content, // HTML content from Claude
      excerpt: body.excerpt || body.metaDescription || null,
      visa_type: body.visaType,
      content_type: body.contentType,
      target_audience: body.targetAudience || 'Both',
      topic: body.topic || null,
      tags: body.tags || [],
      featured_image_url: body.imageUrl || null,
      reading_time: body.readingTime || '5 min read',
      google_doc_url: body.docUrl || null,
      source_system: 'content-maker-v2',
      news_integration: body.newsIntegration || null,
      rag_integration: body.ragIntegration || null,
      backlink_report: body.backlinkReport || null,
      // Auto-publish or keep as draft (configurable)
      status: body.autoPublish ? 'published' : 'draft',
      published_at: body.autoPublish ? new Date().toISOString() : null,
    };

    // Insert into Supabase
    const { data, error } = await supabase
      .from('articles')
      .insert(articleData)
      .select()
      .single();

    if (error) {
      console.error('Supabase insert error:', error);
      return NextResponse.json({ error: error.message }, { status: 500 });
    }

    return NextResponse.json({
      success: true,
      article: {
        id: data.id,
        slug: data.slug,
        url: `https://www.o1dmatch.com/blog/${data.slug}`,
      },
    });

  } catch (error) {
    console.error('Webhook error:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

---

### Step 3: Blog Pages in Next.js

#### Blog List Page: `/src/app/blog/page.tsx`

```typescript
import { createClient } from '@/lib/supabase/server';
import Link from 'next/link';

export const revalidate = 60; // Revalidate every 60 seconds

export default async function BlogPage() {
  const supabase = createClient();

  const { data: articles } = await supabase
    .from('articles')
    .select('id, title, slug, excerpt, visa_type, content_type, target_audience, featured_image_url, reading_time, published_at')
    .eq('status', 'published')
    .order('published_at', { ascending: false });

  return (
    <div className="max-w-6xl mx-auto px-4 py-12">
      <h1 className="text-4xl font-bold mb-8">Immigration Insights</h1>

      {/* Filter tabs by visa type or audience */}

      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
        {articles?.map((article) => (
          <article key={article.id} className="border rounded-lg overflow-hidden">
            {article.featured_image_url && (
              <img
                src={article.featured_image_url}
                alt={article.title}
                className="w-full h-48 object-cover"
              />
            )}
            <div className="p-6">
              <div className="flex gap-2 mb-3">
                <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                  {article.visa_type}
                </span>
                <span className="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded">
                  {article.target_audience}
                </span>
              </div>
              <h2 className="text-xl font-semibold mb-2">
                <Link href={`/blog/${article.slug}`} className="hover:text-blue-600">
                  {article.title}
                </Link>
              </h2>
              <p className="text-gray-600 text-sm mb-4">{article.excerpt}</p>
              <div className="text-xs text-gray-500">
                {article.reading_time} · {new Date(article.published_at).toLocaleDateString()}
              </div>
            </div>
          </article>
        ))}
      </div>
    </div>
  );
}
```

#### Single Article Page: `/src/app/blog/[slug]/page.tsx`

```typescript
import { createClient } from '@/lib/supabase/server';
import { notFound } from 'next/navigation';
import { Metadata } from 'next';

interface Props {
  params: { slug: string };
}

export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const supabase = createClient();
  const { data: article } = await supabase
    .from('articles')
    .select('title, meta_description, featured_image_url')
    .eq('slug', params.slug)
    .eq('status', 'published')
    .single();

  if (!article) return { title: 'Article Not Found' };

  return {
    title: `${article.title} | O1DMatch`,
    description: article.meta_description,
    openGraph: {
      title: article.title,
      description: article.meta_description || undefined,
      images: article.featured_image_url ? [article.featured_image_url] : undefined,
    },
  };
}

export default async function ArticlePage({ params }: Props) {
  const supabase = createClient();

  const { data: article } = await supabase
    .from('articles')
    .select('*')
    .eq('slug', params.slug)
    .eq('status', 'published')
    .single();

  if (!article) notFound();

  return (
    <article className="max-w-3xl mx-auto px-4 py-12">
      {/* Header */}
      <header className="mb-8">
        <div className="flex gap-2 mb-4">
          <span className="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full">
            {article.visa_type}
          </span>
          <span className="text-sm bg-purple-100 text-purple-800 px-3 py-1 rounded-full">
            {article.content_type}
          </span>
          <span className="text-sm bg-green-100 text-green-800 px-3 py-1 rounded-full">
            For: {article.target_audience}
          </span>
        </div>

        <h1 className="text-4xl font-bold mb-4">{article.title}</h1>

        <div className="text-gray-500 text-sm">
          {article.reading_time} · Published {new Date(article.published_at).toLocaleDateString()}
        </div>
      </header>

      {/* Featured Image */}
      {article.featured_image_url && (
        <img
          src={article.featured_image_url}
          alt={article.title}
          className="w-full rounded-lg mb-8"
        />
      )}

      {/* Content */}
      <div
        className="prose prose-lg max-w-none"
        dangerouslySetInnerHTML={{ __html: article.content }}
      />

      {/* Tags */}
      {article.tags && article.tags.length > 0 && (
        <div className="mt-8 pt-8 border-t">
          <div className="flex flex-wrap gap-2">
            {article.tags.map((tag: string) => (
              <span key={tag} className="text-sm bg-gray-100 px-3 py-1 rounded-full">
                #{tag}
              </span>
            ))}
          </div>
        </div>
      )}

      {/* CTA */}
      <div className="mt-12 p-8 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl text-white text-center">
        <h3 className="text-2xl font-bold mb-4">Ready to Start Your O-1 Journey?</h3>
        <p className="mb-6">Join O1DMatch to connect with employers and build your visa case.</p>
        <a
          href="/waitlist"
          className="inline-block bg-white text-blue-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100"
        >
          Join the Waitlist
        </a>
      </div>
    </article>
  );
}
```

---

### Step 4: Update Google Apps Script

Add this function to `Code_v2.0_FIXED.gs`:

```javascript
// ============================================================
// SECTION: WEBHOOK PUBLISHING
// ============================================================

/**
 * Publishes article to O1DMatch website via webhook
 * @param {Object} articleData - Article data from generation
 * @param {Object} generatedContent - Full generated content
 * @returns {Object} - Webhook response
 */
function publishToWebsite(articleData, generatedContent) {
  const webhookUrl = getConfig('WEBSITE_WEBHOOK_URL');
  const webhookSecret = getConfig('WEBSITE_WEBHOOK_SECRET');
  const autoPublish = getConfig('AUTO_PUBLISH_TO_WEBSITE') === 'TRUE';

  if (!webhookUrl || !webhookSecret) {
    logMessage('Website webhook not configured, skipping publish', 'WARN', 'publishToWebsite');
    return null;
  }

  const payload = {
    title: generatedContent.title,
    content: generatedContent.content, // HTML content
    metaDescription: generatedContent.metaDescription,
    excerpt: generatedContent.metaDescription,
    visaType: articleData.visaType,
    contentType: articleData.contentType,
    targetAudience: articleData.targetAudience || 'Both',
    topic: articleData.topic,
    tags: generatedContent.suggestedTags || [],
    imageUrl: articleData.imageUrl,
    readingTime: generatedContent.readingTime || '5 min read',
    docUrl: articleData.docUrl,
    newsIntegration: articleData.newsIntegration,
    ragIntegration: articleData.ragIntegration,
    backlinkReport: articleData.backlinkReport,
    autoPublish: autoPublish
  };

  try {
    const response = UrlFetchApp.fetch(webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${webhookSecret}`
      },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    });

    const responseCode = response.getResponseCode();
    const responseText = response.getContentText();

    if (responseCode === 200 || responseCode === 201) {
      const result = JSON.parse(responseText);
      logMessage(`Published to website: ${result.article.url}`, 'INFO', 'publishToWebsite');
      return result;
    } else {
      logMessage(`Website publish failed (${responseCode}): ${responseText}`, 'ERROR', 'publishToWebsite');
      return null;
    }

  } catch (e) {
    logMessage(`Website publish error: ${e.message}`, 'ERROR', 'publishToWebsite');
    return null;
  }
}
```

Then call it in `generateDailyContent()` after creating the doc:

```javascript
// After: createGoogleDoc(...)
// After: archiveArticle(...)

// 14. Publish to website (optional)
const websiteResult = publishToWebsite(articleData, generatedContent);
if (websiteResult) {
  articleData.websiteUrl = websiteResult.article.url;
}

// 15. Send notification (include website URL if published)
sendEmailNotification(articleData);
```

---

### Step 5: Environment Variables

Add to Vercel:
```
CONTENT_MAKER_WEBHOOK_SECRET=your-secure-random-string-here
```

Add to Google Apps Script Config sheet:
```
WEBSITE_WEBHOOK_URL     | https://www.o1dmatch.com/api/articles/webhook
WEBSITE_WEBHOOK_SECRET  | your-secure-random-string-here
AUTO_PUBLISH_TO_WEBSITE | TRUE (or FALSE for manual review)
```

---

## Implementation Checklist

### Database (Supabase)
- [ ] Add `article_status` enum
- [ ] Create `articles` table
- [ ] Add indexes
- [ ] Enable RLS policies

### Backend (Next.js)
- [ ] Create `/api/articles/webhook/route.ts`
- [ ] Add `CONTENT_MAKER_WEBHOOK_SECRET` to env vars
- [ ] Test webhook endpoint

### Frontend (Next.js)
- [ ] Create `/blog/page.tsx` (list view)
- [ ] Create `/blog/[slug]/page.tsx` (detail view)
- [ ] Add blog link to navigation
- [ ] Style with Tailwind

### Google Apps Script
- [ ] Add `publishToWebsite()` function
- [ ] Update `generateDailyContent()` to call webhook
- [ ] Add config values: `WEBSITE_WEBHOOK_URL`, `WEBSITE_WEBHOOK_SECRET`, `AUTO_PUBLISH_TO_WEBSITE`
- [ ] Test end-to-end

### Optional Enhancements
- [ ] Admin panel to review/publish draft articles
- [ ] Blog category/tag filtering
- [ ] Related articles component
- [ ] RSS feed generation
- [ ] Sitemap inclusion for blog URLs
- [ ] Social sharing buttons
- [ ] View count tracking

---

## Security Considerations

1. **Webhook Authentication**: Use a strong, random secret (32+ characters)
2. **Service Role Key**: Never expose in client-side code
3. **RLS Policies**: Only service role can insert via webhook
4. **Rate Limiting**: Consider adding rate limiting to webhook
5. **Input Validation**: Sanitize HTML content before storing

---

## Testing

### Test Webhook Manually

```bash
curl -X POST https://www.o1dmatch.com/api/articles/webhook \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_SECRET" \
  -d '{
    "title": "Test Article",
    "content": "<p>This is a test article.</p>",
    "visaType": "O-1A",
    "contentType": "Educational",
    "targetAudience": "Both",
    "autoPublish": false
  }'
```

---

## Timeline Estimate

| Phase | Tasks |
|-------|-------|
| Phase 1 | Supabase schema + API webhook |
| Phase 2 | Blog pages (list + detail) |
| Phase 3 | Apps Script webhook function |
| Phase 4 | Testing + polish |
| Phase 5 | Admin review panel (optional) |

---

## Questions for Developer

1. Should articles auto-publish or require manual review?
2. Do you want an admin panel to manage articles?
3. Should the blog be at `/blog` or `/resources` or `/insights`?
4. Any specific SEO requirements (structured data, etc.)?
5. Do you want email notifications when articles fail to publish?

---

*Generated for O1DMatch Content Maker v2.0 Integration*
